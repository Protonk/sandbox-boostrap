# Notes

- Initial scaffolding created; no runs yet.
- Ran `scripts/run_workflow.sh`; trace produced a 4-line profile but `sandbox-exec` aborted on iteration 2 (SIGABRT) and shrink could not execute with the traced profile. The original `work/` outputs were cleaned during migration to `out/`.
- Verified `sandbox-exec` works with a permissive profile (`(allow default)`), and `sandbox_target` runs to completion under that profile.
- Migrated outputs to `out/` (overwrite on each run) and removed prior `work/` runs.
- New run after migration: trace advanced to iteration 4 but failed with `sandbox-exec` SIGABRT on iteration 2 and later a profile parse error from an invalid network rule (`local ip "remote:*:2000"`). Outputs are in `book/evidence/experiments/shrink-trace/out/`.
- Captured preflight scan output to `book/evidence/experiments/shrink-trace/out/preflight_scan.json` and `log show` output to `book/evidence/experiments/shrink-trace/out/log_show_sandbox_exec.txt`.
- Hooked preflight scans into `trace_instrumented.sh` (per-iteration) and `run_workflow.sh` (trace profile before shrink).
- Updated trace parsing to use JSON-style logs with a `log show` fallback and added a dyld seed block.
- Current run (`SEED_DYLD=1`) stalls on SIGABRT in iteration 2; stall bundle in `book/evidence/experiments/shrink-trace/out/stall_iter_2/`.
- Manual abort capture saved to `book/evidence/experiments/shrink-trace/out/stdout.txt`, `book/evidence/experiments/shrink-trace/out/stderr.txt`, and `book/evidence/experiments/shrink-trace/out/exitcode.txt` (exit code 134).
- Copied latest crash report to `book/evidence/experiments/shrink-trace/out/sandbox_target-2025-12-24-181523.ips`.
- Updated dyld seed to add `file-map-executable` for system paths, dev node allowances, and a DirectoryService mach-lookup allow.
- Added optional `dyld-support.sb` import, fixture exec allowances for the output directory, and a `DYLD_LOG` mode to capture dyld output.
- Latest run with `DYLD_LOG=1` imported `dyld-support.sb` and appended 11 rules, then hit a parse error (rc=65) from the invalid network rule; `dyld.log` was not created.
- `sandbox_min_exitcode.txt` is 65 on the latest run (parse error).
- Added `sandbox_min` diagnostic; latest `sandbox_min_exitcode.txt` is 71.
- Re-ran `scripts/run_workflow.sh` with defaults after network rule handling changes; trace succeeded in 3 iterations (`metrics.tsv`) with no rc=65 parse failures.
- `sandbox_min` exited 0 under the traced profile (`out/sandbox_min_exitcode.txt`).
- Shrink failed the initial “full sandbox” check because `open(out/hello.txt)` was denied; traced profile only includes `file-write-create` for the file, not `file-write-data` (`out/shrink_stdout.txt`).
- Network denies were dropped into `out/bad_rules.txt` under `NETWORK_RULES=drop`.
- Output overwrites removed earlier `log_show_sandbox_exec.txt`; current `out/` no longer includes that capture.
- Updated trace success criteria to require a success streak (`SUCCESS_STREAK=2`) so the profile is stable under repeated execution.
- Added a pre-shrink validation gate (two runs) before invoking the shrinker; gate outputs are written to `out/pre_shrink_run*_exitcode.txt`.
- Fixed pre-shrink validation to run from the output directory so relative paths match the traced profile.
- Latest run with defaults completed: trace converged in 6 iterations, pre-shrink validation passed, shrink produced `profile.sb.shrunk` with 9 lines; shrink output is in `out/shrink_stdout.txt`.
- Switched `NETWORK_RULES` default to `parsed` with SBPL-aligned normalization (host `*`/`localhost`, unix-socket `path-literal` for path-shaped denies); latest run still converged in 6 iterations and shrink succeeded.
- Network parsing observed 2 network denies and emitted 2 rules; `bad_rules.txt` now only contains invalid `file-ioctl` rules from rule-level validation.
- Added `scripts/shrink_instrumented.sh` to enforce fresh + repeat checks per deletion and `scripts/lint_profile.py` to lint network filters after trace and shrink.
- Added subprocess and network-required fixtures (`sandbox_spawn`, `sandbox_net_required`) plus `scripts/run_matrix.sh` for configuration sweeps.
- Latest run with PID-agnostic deny extraction (`DENY_SCOPE=all`) converged in 6 iterations with a 37-line traced profile; shrink removed 26 lines and produced an 11-line `profile.sb.shrunk` that passes fresh + repeat validation (post-shrink exit codes 0/0).
- Run metadata is recorded in `out/run_summary.txt`.
- Ran `FIXTURE_BIN=sandbox_net_required` into `out/net_required/`: 8 iterations, 43 traced lines, 12-line shrunk profile; shrunk profile retains `network-outbound` for `*:2000`.
- Ran `FIXTURE_BIN=sandbox_spawn` into `out/spawn/`: 7 iterations, 35 traced lines, 6-line shrunk profile; shrunk profile retains `process-fork` and `process-exec*` for `/usr/bin/id`.
